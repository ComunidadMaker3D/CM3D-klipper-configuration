# WARNING. DO NOT EDIT THIS FILE.
# To override settings from this file, you can copy and paste the relevant
# sections into your printer.cfg and change it there.



    #This replicates Prusa's calibrate Z funtionality.
[gcode_macro Tram_Z]
gcode:
    G28
    G1 X90 Y90 F3000
    G1 Z210 F1000 #Update with Z height.
    FORCE_MOVE STEPPER=stepper_z Distance=10 Velocity=10
    G28 Z

[gcode_macro Z_ALIGN_MOTORS]
gcode:
  G1 X125 Y105 Z208 F4000  
  FORCE_MOVE STEPPER=stepper_z DISTANCE=20 VELOCITY=10
  FORCE_MOVE STEPPER=stepper_z DISTANCE=-20 VELOCITY=10
  SET_KINEMATIC_POSITION Z=210
  G28 Z0

[gcode_macro Z_ALIGNMENT_CALIBRATION]
gcode:
  {% set svv = printer.save_variables.variables %}
  {% set delta_z_x = svv.delta_z_x %}
  {% if delta_z_x is not number %}
    Z_ALIGN_MOTORS
    BED_MESH_CALIBRATE
  {% else %}
    {% set probe_row = (printer.configfile.settings.bed_mesh.probe_count[1] /2)|int %}
    {% set left = printer.bed_mesh.probed_matrix[probe_row][0] %}
    {% set right = (printer.bed_mesh.probed_matrix[probe_row]|last) %}
    {% set delta_z_x_new = left -right %}

    {% if (delta_z_x_new-delta_z_x)|abs > 0.1 %}
      Z_ALIGN_MOTORS
      BED_MESH_CALIBRATE
    {% endif %}
  {% endif %}
  BED_MESH_CALIBRATE_SAVE_VAR


[gcode_macro BED_MESH_CALIBRATE_SAVE_VAR]
gcode: 
   # use middle row
   {% set probe_row = (printer.configfile.settings.bed_mesh.probe_count[1] /2)|int %}
   {% set left = printer.bed_mesh.probed_matrix[probe_row][0] %}
   {% set right = (printer.bed_mesh.probed_matrix[probe_row]|last) %}
   {% set delta = left -right %}
   SAVE_VARIABLE VARIABLE=delta_z_x VALUE='{delta}'
